<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>
<%@ page import="java.util.List"%>
<%@ page import="movieList.MovieListVO"%>
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>예매</title>
<!-- jQuery 라이브러리 추가 -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
:root {
	--bg: #000000;
	--card: #ffffff;
	--line: #e0e0e0;
	--txt: #333333;
	--muted: #666666;
	--accent: #ff6b35;
	--radius: 8px;
	--red-accent: #ff0000;
}

* {
	box-sizing: border-box
}

body {
	margin: 0;
	background-color: var(--bg);
	color: var(--txt);
	font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR",
		sans-serif;
	min-height: 100vh;
}

a {
	text-decoration: none;
	color: inherit
}

.wrap {
	max-width: 1200px;
	margin: 0 auto;
	padding: 20px 16px;
}

h1 {
	font-size: 24px;
	margin: 20px 0;
	color: white;
	font-weight: 700;
}

.grid {
	display: grid;
	grid-template-columns: 280px 1fr 300px;
	gap: 20px;
}

.panel {
	background: var(--card);
	color: var(--txt);
	border: 1px solid var(--line);
	border-radius: var(--radius);
	overflow: hidden;
	min-height: 600px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.panel h3 {
	margin: 0;
	padding: 40px;
	border-bottom: 1px solid var(--line);
	font-size: 18px;
	font-weight: 600;
	background-color: #f8f9fa;
}

.panel .body {
	padding: 20px;
	max-height: 70vh;
	overflow: auto;
}

/* 버튼 스타일 */
.btn {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	gap: 8px;
	padding: 12px 16px;
	border-radius: 6px;
	border: 1px solid var(--line);
	background: white;
	color: var(--txt);
	font-weight: 500;
	cursor: pointer;
	transition: all 0.2s;
}

.btn:hover {
	background-color: #f8f9fa;
	border-color: var(--accent);
}

.btn.active {
	background-color: var(--accent);
	color: white;
	border-color: var(--accent);
}

.btn.block {
	display: flex;
	width: 100%;
	margin-bottom: 8px;
}

.btn.ghost {
	background: white;
	border: 1px solid #ddd;
	color: var(--txt);
}

.btn.ghost:hover {
	background: #f8f9fa;
}

.btn.pill {
	border-radius: 20px;
}

.btn.small {
	padding: 8px 12px;
	font-size: 14px;
}

.btn[disabled] {
	opacity: 0.5;
	cursor: not-allowed;
}

/* 목록 */
.list {
	display: grid;
	gap: 8px;
}

.tag {
	font-size: 14px;
	font-weight: 600;
	color: var(--txt);
	margin: 16px 0 8px 0;
}

/* 영화 카드 */
.movie {
	display: flex;
	gap: 12px;
	align-items: center;
	padding: 16px;
	border: 2px solid var(--line);
	border-radius: var(--radius);
	margin-bottom: 12px;
	transition: all 0.2s;
	background: white;
	cursor: pointer;
}

.movie.selected {
	border-color: var(--accent);
	box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
}

.movie:hover {
	border-color: var(--accent);
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.movie img {
	width: 60px;
	height: 80px;
	object-fit: cover;
	border-radius: 4px;
	background: #f0f0f0;
}

.movie .content {
	flex: 1;
}

.movie .title {
	font-weight: 600;
	font-size: 16px;
	margin-bottom: 4px;
	color: var(--txt);
}

.movie .info {
	font-size: 14px;
	color: var(--muted);
	margin-bottom: 2px;
}

/* 날짜 선택 */
.date-list {
	display: flex;
	gap: 8px;
	margin-bottom: 16px;
	flex-wrap: wrap;
}

.date-btn {
	background: white;
	border: 1px solid var(--line);
	color: var(--txt);
	padding: 10px 16px;
	border-radius: 6px;
	cursor: pointer;
	font-size: 14px;
	transition: all 0.2s;
}

.date-btn:hover {
	border-color: var(--accent);
}

.date-btn.active {
	background: var(--accent);
	color: white;
	border-color: var(--accent);
}

/* 시간 목록 */
.time-list {
	display: flex;
	flex-wrap: wrap;
	gap: 8px;
	margin-top: 16px;
}

.time {
	padding: 8px 12px;
	border: 1px solid var(--line);
	border-radius: 4px;
	background: white;
	font-size: 14px;
	cursor: pointer;
	transition: all 0.2s;
}

.time.active {
	background: var(--accent);
	color: white;
	border-color: var(--accent);
}

.time:hover {
	border-color: var(--accent);
	background: #fff5f0;
}

.time.active:hover {
	background: #e55a2b;
}

.selected-date {
	color: var(--muted);
	font-size: 14px;
	margin-bottom: 16px;
	padding: 8px 0;
}

hr.line {
	border: 0;
	border-top: 1px solid var(--line);
	margin: 20px 0;
}

.empty-state {
	text-align: center;
	padding: 60px 20px;
	color: var(--muted);
}

/* 최종 버튼 */
.final-btn {
	background: var(--red-accent);
	color: white;
	border: none;
	padding: 16px;
	border-radius: 6px;
	font-size: 16px;
	font-weight: 600;
	cursor: pointer;
	transition: all 0.2s;
	width: 100%;
	margin-top: 20px;
}

.final-btn:hover {
	background: #e60000;
	transform: translateY(-1px);
}

/* ★★★ 수정된 지역/영화관 선택 스타일 ★★★ */
.region-section .btn {
	text-align: left;
	justify-content: flex-start;
	background: white;
	color: var(--txt);
	border: 2px solid var(--line);
}

.region-section .btn:hover {
	background: #f8f9fa;
	border-color: var(--accent);
}

.region-section .btn.active {
	background: var(--accent);
	color: white;
	border-color: var(--accent);
}

.cinema-section .btn.ghost {
	text-align: left;
	justify-content: flex-start;
	background: white;
	color: var(--txt);
	border: 2px solid var(--line);
	font-weight: 500;
}

.cinema-section .btn.ghost:hover {
	background: #f8f9fa;
	border-color: var(--accent);
}

.cinema-section .btn.ghost.active {
	background: var(--accent);
	color: white;
	border-color: var(--accent);
}
</style>
</head>
<body>
	<%@ include file="header.jsp"%>

	<main class="wrap">
		<div class="grid">
			<section class="panel">
				<h3>영화관</h3>
				<div class="body">
					<div class="region-section">
						<div class="tag">지역</div>
						<div class="list">
							<c:set var="locations" value="" />
							<c:forEach var="cinema" items="${cinemaList}">
								<c:if test="${not fn:contains(locations, cinema.location)}">
									<button type="button" class="btn block location-btn"
										data-location="${cinema.location}">
										${cinema.location}</button>
									<c:set var="locations" value="${locations}${cinema.location}," />
								</c:if>
							</c:forEach>
						</div>
					</div>
					<hr class="line">
					<div class="cinema-section">
						<div class="tag">영화관</div>
						<div class="list" id="cinemaList">
							<div class="empty-state">지역을 먼저 선택해주세요</div>
						</div>
					</div>
				</div>
			</section>

			<section class="panel">
				<h3>영화 선택</h3>
				<div class="body">
					<c:choose>
						<c:when test="${not empty movieList}">
							<c:forEach var="movie" items="${movieList}">
								<div class="movie">
									<img
										src="${movie.poster != null ? movie.poster : 'asset/images/movie_default.png'}"
										alt="${movie.movieTitle}"
										onerror="this.src='${pageContext.request.contextPath}/asset/images/movie_default.png'">
									<div class="content">
										<div class="title">${movie.movieTitle}</div>
										<div class="info">${movie.genre}•${movie.movieTime}분</div>
									</div>
								</div>
							</c:forEach>
						</c:when>
						<c:otherwise>
							<div class="empty-state">
								<p>현재 상영 중인 영화가 없습니다.</p>
							</div>
						</c:otherwise>
					</c:choose>
				</div>
			</section>

			<section class="panel">
				<h3>2025-08-15(오늘)</h3>
				<div class="body">
					<div class="tag">날짜</div>
					<div class="date-list">
						<button type="button" class="date-btn active"
							data-date="2025-08-15">
							15<br> <small>오늘</small>
						</button>
						<button type="button" class="date-btn" data-date="2025-08-16">
							16<br> <small>토</small>
						</button>
						<button type="button" class="date-btn" data-date="2025-08-17">
							17<br> <small>일</small>
						</button>
						<button type="button" class="date-btn" data-date="2025-08-18">
							18<br> <small>월</small>
						</button>
						<button type="button" class="date-btn" data-date="2025-08-19">
							19<br> <small>화</small>
						</button>
					</div>

					<div class="selected-date" id="selected-date">2025-08-15 (오늘)
						선택됨</div>

					<div class="tag">시간</div>
					<div class="time-list" id="time-list">
						<div class="time">10:30</div>
						<div class="time">13:00</div>
						<div class="time">15:30</div>
						<div class="time">18:00</div>
						<div class="time">20:30</div>
					</div>

					<button type="button" class="final-btn" onclick="goToSeat()">좌석
						선택</button>
				</div>
			</section>
		</div>
	</main>

	<script type="text/javascript">
		$(document).ready(function() {
			// 1. 지역 버튼 클릭 이벤트
			$(document).on('click', '.location-btn', function() {
    			console.log('지역 버튼 클릭됨');
				
				// 모든 지역 버튼에서 active 클래스 제거
				$('.location-btn').removeClass('active');
				// 클릭된 버튼에 active 클래스 추가
				$(this).addClass('active');
				
				let location = $(this).data('location');
				console.log('선택된 지역:', location);
				
				// Ajax 요청
				$.ajax({
					url: 'CinemaServlet',           
					data: {'location': location},        
					dataType: "json",                    
					success: changeCinema,
					error: function(xhr, status, error) {
						console.error('Ajax 에러:', error);
						console.error('응답:', xhr.responseText);
					}
				});
			});

			// 2. 영화관 데이터 업데이트 함수
			function changeCinema(data) {
			    console.log('Ajax 성공! 받은 데이터:', data);
			    console.log('데이터 타입:', typeof data);
			    console.log('데이터 키 개수:', Object.keys(data).length);
			    
			    let cinemaListDiv = $('#cinemaList');
			    cinemaListDiv.empty();
			    
			    if(Object.keys(data).length == 0) {
			        cinemaListDiv.append('<div class="empty-state">해당 지역에 영화관이 없습니다</div>');
			        return;
			    }
			    
			    // ★ 템플릿 리터럴 대신 jQuery 방식으로 생성
			    for(let key in data) {
			        console.log('처리 중 - 키:', key, '값:', data[key]);
			        
			        // jQuery로 버튼 생성
			        let newButton = $('<button></button>')
			            .attr('type', 'button')
			            .addClass('btn block ghost cinema-btn')
			            .attr('data-cinema-id', key)
			            .text(data[key]); // 텍스트 직접 설정
			        
			        cinemaListDiv.append(newButton);
			        console.log('버튼 생성 완료:', data[key]);
			    }
			    
			    console.log('생성된 버튼 개수:', $('#cinemaList .cinema-btn').length);
			    
			    // 생성 확인
			    $('.cinema-btn').each(function() {
			        console.log('실제 버튼 텍스트:', $(this).text());
			    });
			}

			// 3. 영화관 버튼 클릭 이벤트 (동적 생성되는 버튼이므로 on 사용)
			$('#cinemaList').on('click', '.cinema-btn', function() {
				console.log('영화관 선택:', $(this).text());
				
				// 모든 영화관 버튼에서 active 클래스 제거
				$('.cinema-btn').removeClass('active');
				// 클릭된 버튼에 active 클래스 추가
				$(this).addClass('active');
			});

			// 4. 영화 선택 이벤트
			$('.movie').click(function() {
				$('.movie').removeClass('selected');
				$(this).addClass('selected');
			});

			// 5. 날짜 선택 이벤트
			$('.date-btn').click(function() {
				$('.date-btn').removeClass('active');
				$(this).addClass('active');
				
				const date = $(this).data('date');
				const day = $(this).find('small').text();
				$('#selected-date').text(`${date} (${day}) 선택됨`);
			});

			// 6. 시간 선택 이벤트
			$('#time-list').on('click', '.time', function() {
				$('.time').removeClass('active');
				$(this).addClass('active');
				console.log('선택된 시간:', $(this).text());
			});
		});

		// 좌석 선택 페이지로 이동
		function goToSeat() {
			const selectedMovie = $('.movie.selected');
			if (selectedMovie.length === 0) {
				alert('영화를 먼저 선택해주세요.');
				return;
			}
			
			const selectedTime = $('.time.active');
			if (selectedTime.length === 0) {
				alert('상영 시간을 선택해주세요.');
				return;
			}

			alert('좌석 선택 페이지로 이동합니다!');
			// window.location.href = 'seat.jsp';
		}
	</script>

</body>
</html>